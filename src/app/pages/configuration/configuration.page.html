<!-- HEADER SUPERIOR -->
<div class="header">
  <div class="header-left">
    <button class="back-btn" (click)="goBack()">
      <lucide-angular [img]="ChevronLeft" [size]="24"></lucide-angular>
    </button>
    <div class="titulo">Configuración</div>
  </div>
  <div class="header-right"></div>
</div>

<ion-content [fullscreen]="true" class="config-content">
  <!-- TABS DE NAVEGACIÓN -->
  <div class="tabs-container">
    <button 
      class="tab-btn" 
      [class.active]="selectedTab === 'bluetooth'"
      (click)="selectedTab = 'bluetooth'">
      <lucide-angular [img]="Bluetooth" [size]="20"></lucide-angular>
      <span>Dispositivo</span>
    </button>
    <button 
      class="tab-btn" 
      [class.active]="selectedTab === 'recovery-email'"
      (click)="selectedTab = 'recovery-email'">
      <lucide-angular [img]="Mail" [size]="20"></lucide-angular>
      <span>Email de Recuperación</span>
    </button>
  </div>

  <div class="config-container">
    <!-- SECCIÓN DE EMAIL DE RECUPERACIÓN -->
    <div *ngIf="selectedTab === 'recovery-email'" class="step-section recovery-section">
      <div class="section-header">
        <h2 class="section-title">Email de Recuperación</h2>
        <p class="section-subtitle">Configura un email adicional para recuperar tu contraseña</p>
      </div>

      <div class="info-card">
        <div class="info-icon">
          <lucide-angular [img]="Info" [size]="24"></lucide-angular>
        </div>
        <div class="info-text">
          <p><strong>¿Para qué sirve?</strong></p>
          <p>Si olvidas tu contraseña, podrás recuperarla usando este email de recuperación. Es diferente al email con el que iniciaste sesión.</p>
        </div>
      </div>

      <div class="email-status-card">
        <div class="status-header">
          <h3>Estado Actual</h3>
          <div class="status-badge" [class.configured]="user?.email_recuperacion">
            <lucide-angular *ngIf="user?.email_recuperacion" [img]="CheckCircle2" [size]="20"></lucide-angular>
            <lucide-angular *ngIf="!user?.email_recuperacion" [img]="AlertCircle" [size]="20"></lucide-angular>
            <span>{{ user?.email_recuperacion ? 'Configurado' : 'No Configurado' }}</span>
          </div>
        </div>
        
        <div class="email-info" *ngIf="user">
          <div class="email-row">
            <span class="label">Email Principal:</span>
            <span class="value">{{ user.email }}</span>
          </div>
          <div class="email-row">
            <span class="label">Email de Recuperación:</span>
            <span class="value" *ngIf="user.email_recuperacion">{{ user.email_recuperacion }}</span>
            <span class="value no-config" *ngIf="!user.email_recuperacion">No configurado</span>
          </div>
        </div>

        <div class="action-buttons">
          <button class="btn-primary" (click)="openRecoveryEmailEdit()">
            <lucide-angular *ngIf="user?.email_recuperacion" [img]="Edit" [size]="18"></lucide-angular>
            <lucide-angular *ngIf="!user?.email_recuperacion" [img]="PlusCircle" [size]="18"></lucide-angular>
            <span>{{ user?.email_recuperacion ? 'Cambiar' : 'Añadir' }} Email</span>
          </button>
          <button 
            *ngIf="user?.email_recuperacion" 
            class="btn-danger" 
            (click)="removeRecoveryEmail()">
            <lucide-angular [img]="Trash2" [size]="18"></lucide-angular>
            <span>Eliminar</span>
          </button>
        </div>
      </div>
    </div>

    <!-- PASO 1: BLUETOOTH -->
    <div *ngIf="selectedTab === 'bluetooth' && connectionStep === 'bluetooth'" class="step-section">
      <div class="section-header">
        <h2 class="section-title">Conectar Dispositivo</h2>
        <p class="section-subtitle">Escanea y selecciona tu dispositivo ESP32</p>
      </div>

      <!-- Dispositivo conectado actual -->
      <div *ngIf="connectedDevice" class="connected-device-card">
        <div class="device-status-header">
          <div class="status-badge">
            <lucide-angular [img]="Bluetooth" [size]="20"></lucide-angular>
            <span>Conectado</span>
          </div>
          <button class="btn-disconnect" (click)="disconnectDevice()">
            <lucide-angular [img]="XCircle" [size]="18"></lucide-angular>
            Desconectar
          </button>
        </div>
        <div class="device-info">
          <h3>{{ connectedDevice.name }}</h3>
          <p>ID: {{ connectedDevice.id }}</p>
        </div>
        <button class="btn-next" (click)="connectionStep = 'wifi-manual'">
          <span>Continuar a WiFi</span>
          <lucide-angular [img]="ArrowRight" [size]="18"></lucide-angular>
        </button>
      </div>

      <!-- Escaneo de dispositivos -->
      <div *ngIf="!connectedDevice" class="scan-section">
        <div class="scan-buttons">
          <button 
            *ngIf="!isScanning" 
            class="btn-primary" 
            (click)="startScan()">
            <lucide-angular [img]="Bluetooth" [size]="20"></lucide-angular>
            Buscar Dispositivos
          </button>
          <button 
            *ngIf="isScanning" 
            class="btn-primary loading" 
            disabled>
            <lucide-angular [img]="RefreshCw" [size]="20" class="spin"></lucide-angular>
            Escaneando...
          </button>
        </div>

        <!-- Lista de dispositivos encontrados -->
        <div *ngIf="bluetoothDevices.length > 0" class="devices-list">
          <h3 class="list-title">Dispositivos Disponibles</h3>
          <div 
            *ngFor="let device of bluetoothDevices" 
            class="device-item"
            (click)="connectDevice(device)">
            <div class="device-icon">
              <lucide-angular [img]="Bluetooth" [size]="24"></lucide-angular>
            </div>
            <div class="device-content">
              <h4 class="device-name">{{ device.name }}</h4>
              <p class="device-signal">
                <lucide-angular [img]="Wifi" [size]="16"></lucide-angular>
                {{ getRSSIIndicator(device.rssi || -70) }} ({{ device.rssi }} dBm)
              </p>
            </div>
            <lucide-angular [img]="ChevronRight" [size]="20" class="chevron"></lucide-angular>
          </div>
        </div>

        <!-- Sin dispositivos encontrados -->
        <div *ngIf="!isScanning && bluetoothDevices.length === 0 && bluetoothDevices.length !== undefined" class="empty-state">
          <lucide-angular [img]="Bluetooth" [size]="48" class="empty-icon"></lucide-angular>
          <h3>Sin dispositivos encontrados</h3>
          <p>Asegúrate de que tu ESP32 está encendido y con Bluetooth activo</p>
        </div>
      </div>
    </div>

    <!-- PASO 2: ENTRADA MANUAL DE CREDENCIALES WiFi -->
    <div *ngIf="connectionStep === 'wifi-manual' && connectedDevice" class="step-section">
      <div class="section-header">
        <h2 class="section-title">Configurar WiFi</h2>
        <p class="section-subtitle">Ingresa las credenciales de tu red WiFi</p>
      </div>

      <!-- Dispositivo conectado en header -->
      <div class="mini-device-card">
        <lucide-angular [img]="Bluetooth" [size]="20"></lucide-angular>
        <span>{{ connectedDevice.name }}</span>
        <span class="status-dot connected"></span>
      </div>

      <!-- Estado de conexión WiFi -->
      <div class="wifi-status-card" *ngIf="wifiStatus !== 'idle'">
        <div class="status-row" [ngClass]="wifiStatus">
          <lucide-angular 
            *ngIf="wifiStatus === 'sending' || wifiStatus === 'waiting'" 
            [img]="RefreshCw" [size]="20" class="spin">
          </lucide-angular>
          <lucide-angular 
            *ngIf="wifiStatus === 'connected'" 
            [img]="CheckCircle2" [size]="20">
          </lucide-angular>
          <lucide-angular 
            *ngIf="wifiStatus === 'failed'" 
            [img]="AlertCircle" [size]="20">
          </lucide-angular>
          <div class="status-text">
            <span *ngIf="wifiStatus === 'sending'">Enviando credenciales al ESP32...</span>
            <span *ngIf="wifiStatus === 'waiting'">Esperando que el ESP32 conecte a WiFi...</span>
            <span *ngIf="wifiStatus === 'connected'">¡Conectado a WiFi exitosamente!</span>
            <span *ngIf="wifiStatus === 'failed'">Error al conectar. Intenta de nuevo.</span>
          </div>
        </div>
      </div>

      <!-- Formulario de credenciales WiFi -->
      <div class="wifi-form" [class.disabled]="isConnectingWiFi">
        <div class="form-group">
          <label class="input-label">Nombre de la red (SSID)</label>
          <input 
            type="text" 
            class="wifi-input"
            placeholder="Mi-Red-WiFi"
            [(ngModel)]="manualSSID"
            [disabled]="isConnectingWiFi"
            autocomplete="off">
          <div class="help-text">
            <lucide-angular [img]="Info" [size]="14"></lucide-angular>
            <span>Escribe el nombre exacto de tu red WiFi</span>
          </div>
        </div>

        <div class="form-group">
          <label class="input-label">Contraseña</label>
          <input 
            type="password" 
            class="wifi-input"
            placeholder="Contraseña de la red"
            [(ngModel)]="wifiPassword"
            [disabled]="isConnectingWiFi"
            autocomplete="off">
          <div class="help-text">
            <lucide-angular [img]="Info" [size]="14"></lucide-angular>
            <span>La contraseña de tu red WiFi</span>
          </div>
        </div>
      </div>

      <!-- Botones de acción -->
      <div class="config-actions">
        <button 
          class="btn-secondary" 
          [disabled]="isConnectingWiFi"
          (click)="connectionStep = 'bluetooth'">
          <lucide-angular [img]="ChevronLeft" [size]="18"></lucide-angular>
          Volver
        </button>
        <button 
          class="btn-primary" 
          [disabled]="!manualSSID || !wifiPassword || isConnectingWiFi"
          (click)="sendWiFiCredentials()">
          <lucide-angular *ngIf="isConnectingWiFi" [img]="RefreshCw" [size]="18" class="spin"></lucide-angular>
          <lucide-angular *ngIf="!isConnectingWiFi" [img]="Wifi" [size]="18"></lucide-angular>
          <span *ngIf="wifiStatus === 'idle' || wifiStatus === 'failed'">Conectar WiFi</span>
          <span *ngIf="wifiStatus === 'sending'">Enviando...</span>
          <span *ngIf="wifiStatus === 'waiting'">Esperando...</span>
        </button>
      </div>
    </div>

    <!-- PASO 3: INFORMACIÓN DEL ADULTO MAYOR ya no se usa aquí -->
    <!-- El modal se abre automáticamente después de la conexión WiFi exitosa -->
  </div>

  <!-- Modal para editar email de recuperación -->
  <div class="modal-overlay" *ngIf="isEditingRecoveryEmail" (click)="closeRecoveryEmailEdit()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ user?.email_recuperacion ? 'Cambiar' : 'Añadir' }} Email de Recuperación</h2>
        <button class="btn-close" (click)="closeRecoveryEmailEdit()">
          <lucide-angular [img]="XCircle" [size]="24"></lucide-angular>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label>Email Principal (Login)</label>
          <div class="current-email">{{ user?.email }}</div>
        </div>

        <div class="form-group">
          <label for="recoveryEmail">Email de Recuperación</label>
          <input 
            type="email" 
            id="recoveryEmail"
            [(ngModel)]="recoveryEmail"
            (input)="validateRecoveryEmail()"
            placeholder="recuperacion@ejemplo.com"
            class="input-field"
            [class.error]="recoveryEmailError"
          />
          <div class="error-message" *ngIf="recoveryEmailError">
            {{ recoveryEmailError }}
          </div>
          <div class="help-text" *ngIf="!recoveryEmailError">
            Este email se usará únicamente para recuperar tu contraseña
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeRecoveryEmailEdit()">
          Cancelar
        </button>
        <button 
          class="btn-primary" 
          (click)="updateRecoveryEmail()"
          [disabled]="recoveryEmailError || loadingRecoveryEmail">
          <ion-spinner *ngIf="loadingRecoveryEmail" name="crescent"></ion-spinner>
          <span *ngIf="!loadingRecoveryEmail">Guardar</span>
        </button>
      </div>
    </div>
  </div>
</ion-content>
