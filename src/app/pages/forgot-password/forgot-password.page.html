<ion-content class="forgot-password">
  <div class="layout">
    <!-- Header -->
    <div class="header-section">
      <button class="back-btn" (click)="goBack()" aria-label="Volver">
        <ion-icon name="chevron-back"></ion-icon>
      </button>
      <h1 class="title">Recuperar Acceso</h1>
    </div>

    <!-- Progress Bar -->
    <div class="progress-bar">
      <div class="fill" [style.width.%]="(step === 'email' ? 33 : step === 'code' ? 66 : 100)"></div>
    </div>

    <!-- Step 1: Email -->
    <div *ngIf="step === 'email'" class="card">
      <!-- Step Indicator -->
      <div class="step-indicator">
        <div class="indicator active"></div>
        <div class="indicator"></div>
        <div class="indicator"></div>
      </div>

      <div class="step-header">
        <h2>Verifica tu Email</h2>
        <p>Ingresa el <strong>correo de recuperación</strong> asociado a tu cuenta (configurado en Ajustes) y enviaremos un código</p>
      </div>

      <form (ngSubmit)="requestReset()" #emailForm="ngForm">
        <ion-item 
          class="field" 
          lines="none"
          [class.ion-invalid]="emailError"
          [class.ion-touched]="email.length > 0"
        >
          <ion-label position="stacked">
            <ion-icon name="mail-outline" slot="start"></ion-icon>
            Email de Recuperación
          </ion-label>
          <ion-input
            type="email"
            name="email"
            placeholder="recuperacion@correo.com"
            [(ngModel)]="email"
            inputmode="email"
            autocomplete="email"
            required
            (ionInput)="validateEmail()"
            (ionBlur)="validateEmail()"
            aria-label="Correo electrónico"
            aria-describedby="email-error"
          ></ion-input>
        </ion-item>
        <p 
          id="email-error" 
          class="error" 
          *ngIf="emailError" 
          role="alert"
        >{{ emailError }}</p>

        <ion-button 
          expand="block" 
          class="primary" 
          type="submit"
          [disabled]="!emailValid(email) || loading"
          aria-label="Enviar código"
        >
          <ion-spinner *ngIf="loading" name="crescent"></ion-spinner>
          <span *ngIf="!loading">Enviar Código</span>
        </ion-button>

        <p class="resend-section">
          ¿Recordaste tu contraseña?
          <button type="button" class="link" (click)="goBack()">
            Volver al login
          </button>
        </p>
      </form>
    </div>

    <!-- Step 2: Verification Code -->
    <div *ngIf="step === 'code'" class="card">
      <!-- Step Indicator -->
      <div class="step-indicator">
        <div class="indicator active"></div>
        <div class="indicator active"></div>
        <div class="indicator"></div>
      </div>

      <div class="step-header">
        <h2>Ingresa el Código</h2>
        <p>Hemos enviado un código de 6 dígitos a {{ email }}</p>
      </div>

      <form (ngSubmit)="verifyCode()" #codeForm="ngForm">
        <ion-item 
          class="field" 
          lines="none"
          [class.ion-invalid]="codeError"
          [class.ion-touched]="resetCode.length > 0"
        >
          <ion-label position="stacked">
            <ion-icon name="key-outline" slot="start"></ion-icon>
            Código de Verificación
          </ion-label>
          <ion-input
            name="code"
            placeholder="000000"
            [(ngModel)]="resetCode"
            maxlength="6"
            inputmode="numeric"
            required
            aria-label="Código de verificación"
            aria-describedby="code-error"
          ></ion-input>
        </ion-item>
        <p 
          id="code-error" 
          class="error" 
          *ngIf="codeError" 
          role="alert"
        >{{ codeError }}</p>

        <ion-button 
          expand="block" 
          class="primary" 
          type="submit"
          [disabled]="resetCode.length < 4 || loading"
          aria-label="Verificar código"
        >
          <ion-spinner *ngIf="loading" name="crescent"></ion-spinner>
          <span *ngIf="!loading">Verificar Código</span>
        </ion-button>

        <p class="resend-section">
          ¿No recibiste el código?
          <button type="button" class="link" (click)="requestReset()">
            Reenviar
          </button>
        </p>
      </form>
    </div>

    <!-- Step 3: New Password -->
    <div *ngIf="step === 'reset'" class="card">
      <!-- Step Indicator -->
      <div class="step-indicator">
        <div class="indicator active"></div>
        <div class="indicator active"></div>
        <div class="indicator active"></div>
      </div>

      <div class="step-header">
        <h2>Nueva Contraseña</h2>
        <p>Crea una contraseña segura y fácil de recordar</p>
      </div>

      <form (ngSubmit)="resetPassword()" #resetForm="ngForm">
        <!-- New Password Field -->
        <ion-item 
          class="field" 
          lines="none"
          [class.ion-invalid]="passwordError && newPassword.length > 0"
          [class.ion-touched]="newPassword.length > 0"
        >
          <ion-label position="stacked">
            <ion-icon name="lock-closed-outline" slot="start"></ion-icon>
            Nueva Contraseña
          </ion-label>
          <ion-input
            [type]="passwordVisible ? 'text' : 'password'"
            name="password"
            placeholder="••••••••"
            [(ngModel)]="newPassword"
            required
            minlength="6"
            (ionBlur)="validatePassword()"
            (ionInput)="validatePassword()"
            aria-label="Nueva contraseña"
            aria-describedby="password-error"
          >
            <ion-icon 
              slot="end"
              [name]="passwordVisible ? 'eye-off-outline' : 'eye-outline'"
              class="toggle-icon"
              (click)="togglePassword()"
              [attr.aria-label]="passwordVisible ? 'Ocultar contraseña' : 'Mostrar contraseña'"
            ></ion-icon>
          </ion-input>
        </ion-item>

        <!-- Confirm Password Field -->
        <ion-item 
          class="field" 
          lines="none"
          [class.ion-invalid]="passwordError && confirmPassword.length > 0"
          [class.ion-touched]="confirmPassword.length > 0"
        >
          <ion-label position="stacked">
            <ion-icon name="lock-closed-outline" slot="start"></ion-icon>
            Confirmar Contraseña
          </ion-label>
          <ion-input
            [type]="confirmPasswordVisible ? 'text' : 'password'"
            name="confirmPassword"
            placeholder="••••••••"
            [(ngModel)]="confirmPassword"
            required
            (ionBlur)="validatePassword()"
            (ionInput)="validatePassword()"
            aria-label="Confirmar contraseña"
          >
            <ion-icon 
              slot="end"
              [name]="confirmPasswordVisible ? 'eye-off-outline' : 'eye-outline'"
              class="toggle-icon"
              (click)="toggleConfirmPassword()"
              [attr.aria-label]="confirmPasswordVisible ? 'Ocultar contraseña' : 'Mostrar contraseña'"
            ></ion-icon>
          </ion-input>
        </ion-item>
        <p 
          id="password-error" 
          class="error" 
          *ngIf="passwordError" 
          role="alert"
        >{{ passwordError }}</p>

        <ion-button 
          expand="block" 
          class="primary" 
          type="submit"
          [disabled]="newPassword.length < 6 || newPassword !== confirmPassword || loading"
          aria-label="Actualizar contraseña"
        >
          <ion-spinner *ngIf="loading" name="crescent"></ion-spinner>
          <span *ngIf="!loading">Actualizar Contraseña</span>
        </ion-button>
      </form>
    </div>
  </div>
</ion-content>
