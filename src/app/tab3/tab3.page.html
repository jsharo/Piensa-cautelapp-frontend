<!-- HEADER SUPERIOR -->
<div class="header" [class.selection-mode]="isSelectionMode">
  <!-- Header normal -->
  <div class="header-left" *ngIf="!isSelectionMode">
    <div class="titulo">Alarmas</div>
  </div>
  <div class="header-right" *ngIf="!isSelectionMode">
    <button class="profile-btn" (click)="openProfileMenu($event)">
      <img *ngIf="userProfileImage" [src]="userProfileImage" alt="Perfil" class="profile-img">
      <ion-icon *ngIf="!userProfileImage" name="person-circle" class="profile-icon"></ion-icon>
    </button>
  </div>

  <!-- Header modo selección -->
  <div class="selection-header" *ngIf="isSelectionMode">
    <button class="close-selection-btn" (click)="exitSelectionMode()">
      <ion-icon name="close-outline"></ion-icon>
    </button>
    <div class="selection-count">{{ selectedAlarms.size }} elemento{{ selectedAlarms.size !== 1 ? 's' : '' }} seleccionado{{ selectedAlarms.size !== 1 ? 's' : '' }}</div>
    <button class="delete-selection-btn" (click)="deleteSelectedAlarms()" [disabled]="selectedAlarms.size === 0">
      <ion-icon name="trash-outline"></ion-icon>
    </button>
  </div>
</div>

<ion-content [fullscreen]="true" class="fondotab3">

  <div class="content-wrapper">
    <!-- Stats Cards -->
    <div class="stats-container">
      <div class="stat-card">
        <ion-icon name="alarm-outline" class="stat-icon"></ion-icon>
        <div class="stat-info">
          <div class="stat-value">{{ alarms.length }}</div>
          <div class="stat-label">Total</div>
        </div>
      </div>
      <div class="stat-card">
        <ion-icon name="checkmark-circle-outline" class="stat-icon active"></ion-icon>
        <div class="stat-info">
          <div class="stat-value">{{ getActiveAlarmsCount() }}</div>
          <div class="stat-label">Activas</div>
        </div>
      </div>
    </div>

    <!-- Filter Tabs -->
    <div class="filter-tabs">
      <button class="filter-tab" [class.active]="selectedCategory === 'all'" (click)="filterByCategory('all')">
        Todas
      </button>
      <button class="filter-tab" [class.active]="selectedCategory === 'medicamento'"
        (click)="filterByCategory('medicamento')">
        <ion-icon name="medical-outline"></ion-icon>
        Medicamentos
      </button>
      <button class="filter-tab" [class.active]="selectedCategory === 'cita'" (click)="filterByCategory('cita')">
        <ion-icon name="calendar-outline"></ion-icon>
        Citas
      </button>
      <button class="filter-tab" [class.active]="selectedCategory === 'otro'" (click)="filterByCategory('otro')">
        <ion-icon name="notifications-outline"></ion-icon>
        Otros
      </button>
    </div>

    <!-- Botón visible para agregar alarma -->
    <div class="add-alarm-row">
      <button class="btn-add-alarm" (click)="openAddModal()">
        <ion-icon name="add-circle-outline"></ion-icon>
        <span style="margin-left: 8px; font-weight: 600;">Programar Alarma</span>
      </button>
    </div>

    <!-- Alarms List -->
    <div class="alarms-list" *ngIf="getFilteredAlarms().length > 0">
      <ion-item 
        *ngFor="let alarm of getFilteredAlarms()"
        class="alarm-card" 
        [class.disabled]="!alarm.enabled" 
        [class.selected]="isAlarmSelected(alarm)"
        (click)="isSelectionMode ? toggleAlarmSelection(alarm, $event) : editAlarm(alarm)"
        (touchstart)="onTouchStart(alarm, $event)"
        (touchend)="onTouchEnd($event)"
        (touchmove)="onTouchMove($event)"
        lines="none">
        
        <!-- Checkbox en modo selección -->
        <ion-checkbox 
          *ngIf="isSelectionMode" 
          slot="start" 
          [checked]="isAlarmSelected(alarm)"
          (ionChange)="toggleAlarmSelection(alarm, $event)"></ion-checkbox>
        
        <!-- Icono de categoría (solo cuando NO está en modo selección) -->
        <div class="alarm-icon" [attr.data-category]="alarm.category" slot="start" *ngIf="!isSelectionMode">
          <ion-icon [name]="getCategoryIcon(alarm.category)"></ion-icon>
        </div>
        
        <div class="alarm-content">
          <div class="alarm-time">{{ formatTime(alarm.time) }}</div>
          <div class="alarm-label">{{ alarm.label || 'Sin título' }}</div>
          <div class="alarm-days" *ngIf="alarm.repeatDays && alarm.repeatDays.length > 0">
            <span class="day-badge" *ngFor="let day of alarm.repeatDays">{{ getDayAbbr(day) }}</span>
          </div>
        </div>
        
        <!-- Toggle solo visible cuando NO está en modo selección -->
        <ion-toggle 
          *ngIf="!isSelectionMode"
          slot="end" 
          [checked]="alarm.enabled" 
          (ionChange)="toggleAlarm(alarm, $event)"
          (click)="$event.stopPropagation()"></ion-toggle>
      </ion-item>
    </div>

    <div *ngIf="getFilteredAlarms().length === 0" class="empty-state">
      <ion-icon [name]="selectedCategory === 'all' ? 'alarm-outline' : 'filter-outline'"></ion-icon>
      <p>{{ selectedCategory === 'all' ? 'No tienes alarmas configuradas' : 'No hay alarmas en esta categoría' }}</p>
      <ion-button *ngIf="selectedCategory === 'all'" (click)="openAddModal()" class="premium-add-btn" mode="ios">
        Configurar Alarma
      </ion-button>
    </div>
  </div>

</ion-content>


<ion-fab vertical="bottom" horizontal="end" slot="fixed" class="premium-fab">
  <ion-fab-button (click)="openAddModal()" mode="ios">
    <div class="fab-icon-container">
      <svg viewBox="0 0 36 36" class="fab-svg">
        <path fill="#159A9C" d="M16 16v14h4V16z"></path>
        <path fill="#002333" d="M20 16h10v4H20z"></path>
        <path fill="#B4BEC9" d="M6 16h10v4H6z"></path>
        <path fill="#117B7D" d="M16 6h4v10h-4z"></path>
      </svg>
    </div>
  </ion-fab-button>
</ion-fab>